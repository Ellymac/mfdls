\documentclass[12pt]{article}

\usepackage[utf8]{inputenc}
\usepackage{xcolor}
\usepackage[sfdefault]{ClearSans}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
% \usepackage[francais]{babel} je mets ça d'habitude, mais ça dépend des goûts et des couleurs
\usepackage[top=2cm, bottom=2cm, left=2cm, right=2cm]{geometry}
\usepackage{eurosym}
\usepackage{graphicx}
\usepackage{fancybox}

\pagestyle{plain}
\title{Projet MFDLS \\ Vélos en libre service}
\author{Anthony Araye et Camille Schnell}
\date{1 mars 2018}
\begin{document}
\maketitle
\newpage
\renewcommand{\contentsname}{Sommaire}
\tableofcontents
\newpage
\section{Introduction}
L'objectif de ce projet est de modéliser un système permettant à des utilisateurs d'emprunter des vélos en libre service. Ces vélos sont stockés dans plusieurs gares au sein d'une ville. \\ \\
Il s'agit ici de gérer l'ensemble des actions pouvant être effectuées par différentes personnes : des usagers ou des administrateurs du système. Nous avons ainsi modélisé des opérations afin qu'un administrateur puisse créer, supprimer ou débloquer un utilisateur et déplacer ou réparer des vélos ; les usagers pourront emprunter et rendre des vélos, à condition qu'ils ne soient pas bloqués. \\ \\
Les raffinements permettent de ...
\newpage
\section{La machine abstraite}
\textcolor{red}{\textbf{IL FAUT PRÉCISER DANS CETTE SECTION À CHAQUE FOIS QU'UNE PROPRIÉTÉ DU SUJET EST VÉRIFIÉE EN \\ LA CITANT (P1,P2,...)}}
Notre machine abstraite, nommée sobrement Velhop, est caractérisée par différents ensembles, variables et opérations décrites dans les sous-parties ci-dessous.
\subsection{Ensembles, variables et initialisation}
\subsubsection{Ensembles et constantes}
Dans notre machine, nous implémentons deux constantes :
\begin{itemize}
  \item velos : un ensemble entre 1 et 12 représentant les 12 vélos du problème.
  \item gare : un ensemble entre 1 et 4 représentant les 4 gares du problème.
\end{itemize}

De plus, nous introduisons plusieurs ensembles :
\begin{itemize}
  \item PERSONNES : un ensemble représentant les personnes.
  \item ETATS\_VELO : un ensemble représentant l'état que peut avoir un vélo (où ETATS\_VELO = \{bon\_etat, use, abime\})
  \item STATUT : un ensemble représentant l'état d'un compte (où STATUT = \{actif, bloque\}).
\end{itemize}
\subsubsection{Variables et invariant}
Grâce aux ensembles définis par nos soins, nous allons pouvoir définir des variables et des invariants afin de spécifier notre machine.\\

Nous utilisons dans notre machine abstraite 4 variables :
\begin{itemize}
  \item usagers : une fonction partielle de l'ensemble PERSONNE vers un élément de STATUT. Elle représente l'ensemble des utilisateurs du système Velhop.
  \item etatVelos : une fonction totale de l'ensemble velos vers l'ensemble ETATSVELO. Pour chaque vélo, on attribue un état afin de savoir si le vélo est utilisable ou non.
  \item usagerVelo : une fonction partielle et injective du domaine de la fonction usager vers l'ensemble velos. Elle attribue pour un utilisateur un vélo. La fonction est partielle pour justifier la propriété 2. L'injectivité permet de définir le fait qu'un vélo ne peut être emprunté que par une seule personne.
  \item gares : une fonction totale de l'ensemble gare à un ensemble de fonctions partielles de [|1,6|] vers l'ensemble velos. Cette fonction permet de lier pour chaque gare, un ensemble de 6 bornes pouvant contenir 0 ou 1 vélo. Elle respecte donc la propriété P1 du sujet.
\end{itemize}

En plus de ces variables (et de leurs invariants), on a ajouté un dernier invariant : %!g1.(g1 : dom(gares) => (!v1.(v1 : ran(gares(g1)) => (!g2.(g2 : dom(gares) & g2 /= g1 =>(v1 /: ran(gares(g2))))))))
\[
	\forall g1 \in dom(gares) \Rightarrow (\forall v1 \in ran(gares(g1)) \Rightarrow (\forall g2 \in dom(gares) \land g1 \neq g2 \Rightarrow (v1 \notin ran(gares(g2))) ) )
\]
En résumé, ce prédicat indique qu'un vélo ne peut pas être dans deux gares différentes (par simple logique physique).
\subsubsection{Initialisation}
Nous avons initialisé les quatres variables comme suit :
\begin{itemize}
  \item usagers := \{\} : on l'initialise comme suit car il n'y a aucun utilisateur au moment de la création de Velhop.
  \item etatVelos := velos * {bon\_etat} : tous les vélos sont en bon état au moment de l'initialisation.
  \item usagerVelo := \{\} : comme il n'y a aucun utilisateur, il ne peut pas y avoir d'utilisateur qui a déjà emprunté un vélo.
  \item gares := \{1 |-> \{1 |-> 1, 2 |-> 2, 3 |-> 3\}, 2 |-> \{1 |-> 4, 2 |-> 5, 3 |-> 6\}, 3 |-> \{1 |-> 7, 2 |-> 8, 3 |-> 9\}, 4 |-> \{1 |-> 10, 2 |-> 11, 3 |-> 12\}\} : on répartit 3 vélos dans chacune des quatre gares comme indiqué dans le sujet.
\end{itemize}
\subsection{Opérations implémentées}
\subsubsection{\textit{creer\_usager(user)}}
Cette opération permet de créer un utilisateur dans notre système.
\paragraph{Préconditions}
\[user \in PERSONNES \land user \in dom(usagers)\]

La variable user doit apartenir à l'ensemble PERSONNES et doit également être dans le domaine de la fonction usagers.
\paragraph{Corps de l'opération}
\[ usagers := usagers \bigcup \{user \mapsto actif\} \]

On ajoute à la variable usager le couple (user,actif).
\subsubsection{\textit{supprimer\_usager(user)}}
Cette opération permet de supprimer un utilisateur dans notre système.
\paragraph{Préconditions}
\[user \in PERSONNES \land user \in dom(usagers) \land usagers(user) \neq bloque \land user \neq dom(usagers) \]

\paragraph{Corps de l'opération}
\[ usagers := \{ user \} <<| usagers \]

On fait la soustraction de \{ user \} dans la variable usagers.

\subsubsection{\textit{debloquer\_usager(user)}}
Cette opération permet de débloquer un utilisateur dans notre système.
\paragraph{Préconditions}
\[ user \in PERSONNES \land user \in dom(usagers) \land usagers(user) = bloque \land user \neq dom(usagerVelo) \]

\paragraph{Corps de l'opération}
\[usagers := usagers \leftarrow \{user \mapsto actif\} \]

On fait la surcharge de \{ user -> actif \} dans la variable usagers.
\subsubsection{\textit{emprunter(user,vv,gg)}}
Cette opération permet l'emprunt d'un vélo par un utilisateur dans notre système.
\paragraph{Préconditions}
\[ user \in PERSONNES \land user \in dom(usagers) \land usagers(user) \neq bloque \land user \neq dom(usagerVelo) \]\[\land vv \in velos \land gg \in gare \land vv \neq ran(usagerVelo) \land vv \in ran(gares(gg)) \land etatVelos(vv) = bon\_etat\]
\paragraph{Corps de l'opération}
	\[ usagerVelo := usagerVelo \bigcup \{user \mapsto vv\} ||
gares(gg) := gares(gg) |>> \{vv\}\]

On ajoute à usagerVelo la relation \{ user -> vv \} et on soustrait à l'ensemble gares(gg) les relations dont l'image est vv.
\subsubsection{\textit{rendre(velo,gg,temps,etat)}}
Cette opération permet le rendu d'un vélo par un utilisateur dans notre système.
\paragraph{Préconditions}
\[ velo \in velos \land gg \in gare \land velo \in ran(usagerVelo) \land temps \in NAT1 \land etat \in ETATSVELO\]
\paragraph{Corps de l'opération}
\[ANY xx WHERE xx \in [|1;6|] \land xx \notin dom(gares(gg)) THEN\]
\[ usagerVelo := usagerVelo |>> \{velo\} || \]
\[ etatVelos := etatVelos \leftarrow \{ velo \mapsto etat \} || \]
\[ gares(gg) := gares(gg) \bigcup \{xx \mapsto velo\} || \]
\[ IF temps > 60 or etat = abime THEN \]
\[ usagers := usagers <+ usagerVelo~[\{velo\}] * \{bloque\} \]
\[ END \]
\[END\]

\subsubsection{\textit{deplacer\_velo(vv,gg)}}
Cette opération permet le déplacement instantanée d'un vélo d'une gare à une autre dans notre système.
\paragraph{Préconditions}
\[ vv \in velos \land gg \in gare \land etatVelos(vv) = bon\_etat \land card(gares(gg))<6 \]
\[\land vv \notin ran(gares(gg)) \land vv \notin ran(usagerVelo)\]
\paragraph{Corps de l'opération}
\[ANY ggg WHERE ggg \in gare \land vv \in ran(gares(ggg)) THEN
\]
\[ ANY xx WHERE xx \in [1;6] \land xx \notin dom(gares(gg)) THEN \]
\[ gares := gares \leftarrow \{ggg \mapsto (gares(ggg) |>> \{vv\}), gg \mapsto (gares(gg) \bigcup \{xx \mapsto vv\})\} \]
\[ END \]
\[END\]

\subsubsection{\textit{reparer\_velo(velo)}}
Cette opération permet la réparation d'un vélo dans notre système.
\paragraph{Préconditions}
\[ velo \in velos \land etatVelos(velo) \neq bon\_etat \]
\paragraph{Corps de l'opération}
\[ etatVelos(velo) := bon\_etat \]
\newpage
\section{Scénarios de test}
Voici quelques scénarios utilisés pour tester la machine abstraite Velhop. Après initialisation sur ProB, le résultat obtenu est le suivant : \\
velos = \{1,2,3,4,5,6,7,8,9,10,11,12\};
gare = \{1,2,3,4\}; \\
etatVelos(1) = bon\_etat;
etatVelos(2) = bon\_etat;
etatVelos(3) = bon\_etat;
etatVelos(4) = bon\_etat;
etatVelos(5) = bon\_etat;
etatVelos(6) = bon\_etat;
etatVelos(7) = bon\_etat;
etatVelos(8) = bon\_etat;
etatVelos(9) = bon\_etat;
etatVelos(10) = bon\_etat;
etatVelos(11) = bon\_etat;
etatVelos(12) = bon\_etat;  \\
usagers = \{\};
usagerVelo = \{\}; \\
gares(1) = [1,2,3];
gares(2) = [4,5,6];
gares(3) = [7,8,9];
gares(4) = [10,11,12];
\subsection{Premier scénario}
Ce premier scénario permet de tester la création et suppression d'un usager ainsi que les opérations \textit{emprunter} et \textit{rendre} (sans blocage de l'usager).
\begin{itemize}
  \item Initialisation
  \item Création d'un utilisateur 1 \\
  $\Rightarrow$ \textit{usagers(PERSONNES1) = actif}
  \item L'utilisateur 1 emprunte le vélo 1 à la gare 1 \\
  $\Rightarrow$ \textit{usagers(PERSONNES1) = actif ; usagerVelo(PERSONNES1)=1 ; $gares(1)$ = \{$(2\mapsto2)$,$(3\mapsto3)$\}}
  \item L'utilisateur 1 rend le vélo 1 en bon état à la gare 1 après 30 minutes \\
  $\Rightarrow$ \textit{usagers(PERSONNES1) = actif ; usagerVelo=\{\} ; $gares(1) = [1,2,3]$}
  \item L'utilisateur 1 est supprimé \\
  $\Rightarrow$ \textit{usagers = \{\}}
\end{itemize}
\subsection{Deuxième scénario}
Ce scénario permet de tester le blocage d'un usager lorsqu'il rend un vélo abimé, le déblocage d'un utilisateur et l'opération \textit{réparer} : l'utilisateur débloqué peut emprunter le vélo réparé.
\begin{itemize}
  \item Initialisation
  \item Création d'un utilisateur 1 \\
  $\Rightarrow$ \textit{usagers(PERSONNES1) = actif}
  \item L'utilisateur 1 emprunte le vélo 4 à la gare 2 \\
  $\Rightarrow$ \textit{usagers(PERSONNES1) = actif ; usagerVelo(PERSONNES1)=4 ; $gares(2)$ = \{$(2\mapsto5)$,$(3\mapsto6)$\}}
  \item L'utilisateur 1 rend le vélo 4 abimé à la gare 3 après 45 minutes : il est bloqué \\
  $\Rightarrow$ \textit{usagers(PERSONNES1) = bloque ; usagerVelo=\{\} ; etatVelos(4)=abime; $gares(3) = [7,8,9,4]$}
  \item Le vélo 4 est réparé \\
  $\Rightarrow$ \textit{etatVelos(4) = bon\_etat}
  \item L'utilisateur 1 est débloqué \\
  $\Rightarrow$ \textit{usagers(PERSONNES1) = actif}
  \item L'utilisateur 1 emprunte le vélo 4 à la gare 3 \\
  $\Rightarrow$ \textit{usagers(PERSONNES1) = actif ; usagerVelo(PERSONNES1) = 4 ; $gares(3) = [7,8,9]$}
  \item L'utilisateur 1 rend le vélo 4 en bon état à la gare 1 après 30 minutes \\
  $\Rightarrow$ \textit{usagers(PERSONNES1) = actif ; usagerVelo=\{\} ; $gares(1) = [1,2,3,4]$}
  \item L'utilisateur 1 est supprimé \\
  $\Rightarrow$ \textit{usagers = \{\}}
\end{itemize}
\subsection{Troisième scénario}
Ce scénario permet de tester le blocage d'un usager lorsqu'il rend un vélo après l'avoir utilisé plus de 60 minutes, ainsi que l'opération \textit{déplacer} : un utilisateur peut emprunter un vélo dans la gare 1 après que l'administrateur y ait déplacé ce dernier.
\begin{itemize}
  \item Initialisation
  \item Création d'un utilisateur 1 \\
  $\Rightarrow$ \textit{usagers(PERSONNES1) = actif}
  \item Création d'un utilisateur 2 \\
  $\Rightarrow$ \textit{usagers(PERSONNES2) = actif}
  \item L'utilisateur 1 emprunte le vélo 4 à la gare 2 \\
  $\Rightarrow$ \textit{usagers(PERSONNES1) = actif ; usagerVelo(PERSONNES1)=4 ; $gares(2)$ = \{$(2\mapsto5)$,$(3\mapsto6)$\}}
  \item L'utilisateur 1 rend le vélo 4 en bon état à la gare 3 après 70 minutes : il est bloqué \\
  $\Rightarrow$ \textit{usagers(PERSONNES1) = bloque ; usagerVelo=\{\} ; etatVelos(4)=bon\_etat; $gares(3) = [7,8,9,4]$}
  \item L'administrateur déplace le vélo 4 de la gare 3 vers la gare 1 \\
  $\Rightarrow$ \textit{$gares(1) = [1,2,3,4] ; gares(3) = [7,8,9]$}
  \item L'utilisateur 2 emprunte le vélo 4 à la gare 1 \\
  $\Rightarrow$ \textit{usagers(PERSONNES2) = actif ; usagerVelo(PERSONNES2)=4 ; $gares(1)$ = [1,2,3]}
  \item L'utilisateur 2 rend le vélo 4 en bon état à la gare 1 après 30 minutes \\
  $\Rightarrow$ \textit{usagers(PERSONNES2) = actif ; usagerVelo=\{\} ; etatVelos(4)=bon\_etat; $gares(1) = [1,2,3,4]$}
  \item Les utilisateurs 1 et 2 sont supprimés \\
  $\Rightarrow$ \textit{usagers = \{\}}
\end{itemize}
\newpage
\section{Premier raffinement}
\subsection{Invariant de collage}
\subsection{Modification des opérations}
\newpage
\section{Deuxième raffinement}
\subsection{Invariant de collage}
\subsection{Modification des opérations}
\section{Preuves}
\subsection{Preuves de la machine abstraite}
\subsection{Preuves du premier raffinement}
\subsection{Preuves du deuxième raffinement}
\newpage
\section{Conclusion}



\end{document}
